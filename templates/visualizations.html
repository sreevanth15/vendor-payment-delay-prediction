{% extends "base.html" %}

{% block title %}Data Visualizations - Vendor Payment Prediction{% endblock %}

{% block content %}
<div class="container">
    <div class="content-wrapper">
        <h2 class="mb-4"><i class="fas fa-chart-area text-primary"></i> Advanced Data Visualizations</h2>
        
        <div class="alert alert-info" role="alert">
            <i class="fas fa-info-circle"></i> <strong>Interactive Charts:</strong> 
            Explore payment delay patterns through comprehensive visual analytics
        </div>

        <!-- Row 1: Payment Distribution -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Payment Status Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="paymentStatusPie"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Category Delay Comparison</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="categoryDelayBar"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 2: Time Series and Amount Distribution -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-line"></i> Monthly Payment Trends</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="monthlyTrendLine"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 3: Advanced Analytics -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-money-bill-wave"></i> Invoice Amount Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="amountHistogram"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="fas fa-clock"></i> Payment Terms vs Delay Rate</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="termsScatter"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 4: Vendor Analysis -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header" style="background: #6f42c1; color: white;">
                        <h5 class="mb-0"><i class="fas fa-building"></i> Top 10 Vendors by Volume</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="topVendorsBar"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header" style="background: #e83e8c; color: white;">
                        <h5 class="mb-0"><i class="fas fa-percentage"></i> Delay Rate by Cash Flow Level</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="cashFlowDoughnut"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 5: Heatmap -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0"><i class="fas fa-fire"></i> Category vs Payment Terms Heatmap</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="heatmapChart" height="100"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 6: Model Performance Details -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <h5 class="mb-0"><i class="fas fa-robot"></i> ML Model Performance Metrics</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="modelMetricsRadar"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden data for JavaScript -->
<script id="chartData" type="application/json">
    {{ chart_data | tojson }}
</script>

<script>
// Load data
const chartData = JSON.parse(document.getElementById('chartData').textContent);

// Debug: Log data to console
console.log('Chart Data:', chartData);

// Wait for DOM to be ready
document.addEventListener('DOMContentLoaded', function() {

// 1. Payment Status Pie Chart
new Chart(document.getElementById('paymentStatusPie'), {
    type: 'pie',
    data: {
        labels: ['On-Time Payments', 'Delayed Payments'],
        datasets: [{
            data: [chartData.on_time_count, chartData.delayed_count],
            backgroundColor: ['rgba(75, 192, 192, 0.8)', 'rgba(255, 99, 132, 0.8)'],
            borderColor: ['rgba(75, 192, 192, 1)', 'rgba(255, 99, 132, 1)'],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: 'bottom' },
            title: { display: false }
        }
    }
});

// 2. Category Delay Bar Chart
new Chart(document.getElementById('categoryDelayBar'), {
    type: 'bar',
    data: {
        labels: chartData.categories,
        datasets: [{
            label: 'Delay Rate (%)',
            data: chartData.category_delay_rates,
            backgroundColor: chartData.category_delay_rates.map(rate => 
                rate > 30 ? 'rgba(255, 99, 132, 0.8)' : 
                rate > 20 ? 'rgba(255, 206, 86, 0.8)' : 
                'rgba(75, 192, 192, 0.8)'
            ),
            borderColor: chartData.category_delay_rates.map(rate => 
                rate > 30 ? 'rgba(255, 99, 132, 1)' : 
                rate > 20 ? 'rgba(255, 206, 86, 1)' : 
                'rgba(75, 192, 192, 1)'
            ),
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: { beginAtZero: true, max: 50 }
        },
        plugins: {
            legend: { display: false }
        }
    }
});

// 3. Monthly Trend Line Chart
new Chart(document.getElementById('monthlyTrendLine'), {
    type: 'line',
    data: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
        datasets: [{
            label: 'Delayed Payments',
            data: chartData.monthly_delays,
            borderColor: 'rgba(255, 99, 132, 1)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            tension: 0.4,
            fill: true
        }, {
            label: 'On-Time Payments',
            data: chartData.monthly_ontime,
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: { beginAtZero: true }
        },
        plugins: {
            legend: { position: 'top' }
        }
    }
});

// 4. Invoice Amount Histogram
new Chart(document.getElementById('amountHistogram'), {
    type: 'bar',
    data: {
        labels: ['0-10K', '10K-30K', '30K-50K', '50K-70K', '70K+'],
        datasets: [{
            label: 'Number of Invoices',
            data: chartData.amount_distribution,
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: { beginAtZero: true }
        },
        plugins: {
            legend: { display: false }
        }
    }
});

// 5. Payment Terms Scatter Plot
new Chart(document.getElementById('termsScatter'), {
    type: 'scatter',
    data: {
        datasets: [{
            label: 'Delayed',
            data: chartData.terms_scatter_delayed,
            backgroundColor: 'rgba(255, 99, 132, 0.6)',
            borderColor: 'rgba(255, 99, 132, 1)',
            pointRadius: 5
        }, {
            label: 'On-Time',
            data: chartData.terms_scatter_ontime,
            backgroundColor: 'rgba(75, 192, 192, 0.6)',
            borderColor: 'rgba(75, 192, 192, 1)',
            pointRadius: 5
        }]
    },
    options: {
        responsive: true,
        scales: {
            x: { 
                title: { display: true, text: 'Payment Terms (days)' },
                beginAtZero: true
            },
            y: { 
                title: { display: true, text: 'Invoice Amount ($)' },
                beginAtZero: true
            }
        },
        plugins: {
            legend: { position: 'top' }
        }
    }
});

// 6. Top Vendors Bar Chart (fix for horizontal bar)
new Chart(document.getElementById('topVendorsBar'), {
    type: 'bar',
    data: {
        labels: chartData.top_vendors,
        datasets: [{
            label: 'Total Payments',
            data: chartData.top_vendors_counts,
            backgroundColor: 'rgba(153, 102, 255, 0.6)',
            borderColor: 'rgba(153, 102, 255, 1)',
            borderWidth: 2
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        scales: {
            x: { beginAtZero: true }
        },
        plugins: {
            legend: { display: false }
        }
    }
});

// 7. Cash Flow Doughnut Chart
new Chart(document.getElementById('cashFlowDoughnut'), {
    type: 'doughnut',
    data: {
        labels: ['Low Cash Flow', 'Medium Cash Flow', 'High Cash Flow'],
        datasets: [{
            data: chartData.cashflow_delays,
            backgroundColor: [
                'rgba(255, 99, 132, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)'
            ],
            borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: 'bottom' }
        }
    }
});

// 8. Heatmap (using bar chart approximation)
new Chart(document.getElementById('heatmapChart'), {
    type: 'bar',
    data: {
        labels: chartData.heatmap_labels,
        datasets: chartData.heatmap_datasets
    },
    options: {
        responsive: true,
        scales: {
            x: { stacked: true },
            y: { stacked: true, beginAtZero: true }
        },
        plugins: {
            legend: { position: 'top' }
        }
    }
});

// 9. Model Metrics Radar Chart
new Chart(document.getElementById('modelMetricsRadar'), {
    type: 'radar',
    data: {
        labels: ['Accuracy', 'Precision', 'Recall', 'F1-Score', 'AUC-ROC'],
        datasets: [{
            label: 'Logistic Regression',
            data: [65, 64, 66, 65, 69],
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            borderColor: 'rgba(255, 99, 132, 1)',
            pointBackgroundColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 2
        }, {
            label: 'Random Forest',
            data: [76, 75, 77, 76, 68],
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            pointBackgroundColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 2
        }, {
            label: 'XGBoost',
            data: [75, 74, 76, 75, 66],
            backgroundColor: 'rgba(255, 206, 86, 0.2)',
            borderColor: 'rgba(255, 206, 86, 1)',
            pointBackgroundColor: 'rgba(255, 206, 86, 1)',
            borderWidth: 2
        }, {
            label: 'LightGBM',
            data: [56, 60, 73, 66, 67],
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            pointBackgroundColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        scales: {
            r: {
                beginAtZero: true,
                max: 100
            }
        },
        plugins: {
            legend: { position: 'top' }
        }
    }
});

}); // End DOMContentLoaded
</script>
{% endblock %}
