{% extends "base.html" %}

{% block title %}Bulk Upload - Vendor Payment Prediction{% endblock %}

{% block content %}
<div class="container">
    <div class="content-wrapper">
        <h2 class="mb-4"><i class="fas fa-upload text-primary"></i> Bulk Upload & Prediction</h2>
        
        <div class="alert alert-info" role="alert">
            <i class="fas fa-info-circle"></i> <strong>Batch Processing:</strong> 
            Upload a CSV file with multiple invoices to get predictions for all at once!
        </div>

        <!-- Upload Section -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-file-csv"></i> Upload CSV File</h5>
                    </div>
                    <div class="card-body">
                        <form id="bulkUploadForm">
                            <div class="mb-3">
                                <label for="csvFile" class="form-label">Select CSV File</label>
                                <input type="file" class="form-control" id="csvFile" accept=".csv" required>
                                <div class="form-text">Upload a CSV file with invoice data</div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn">
                                    <i class="fas fa-cloud-upload-alt"></i> Upload & Predict
                                </button>
                            </div>
                        </form>
                        
                        <div class="mt-3" id="progressDiv" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                            </div>
                            <p class="text-center mt-2">Processing your file...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Instructions -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-question-circle"></i> Required CSV Format</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Your CSV file must contain these columns:</strong></p>
                        <ul class="small">
                            <li><code>vendor_id</code> - Vendor identifier</li>
                            <li><code>vendor_category</code> - Category name</li>
                            <li><code>invoice_amount</code> - Invoice amount (number)</li>
                            <li><code>payment_terms</code> - Payment terms in days</li>
                            <li><code>vendor_past_delays</code> - Number of past delays</li>
                            <li><code>cash_flow_level</code> - Low/Medium/High</li>
                            <li><code>vendor_relationship_length</code> - Months</li>
                            <li><code>invoice_date</code> - Date (YYYY-MM-DD)</li>
                            <li><code>due_date</code> - Date (YYYY-MM-DD)</li>
                        </ul>
                        
                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-primary" onclick="downloadSampleCSV()">
                                <i class="fas fa-download"></i> Download Sample CSV
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" style="display: none;">
            <!-- Summary Stats -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Summary Statistics</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <div class="stat-box">
                                        <h3 id="totalCount">0</h3>
                                        <p>Total Records</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-box">
                                        <h3 class="text-danger" id="highRiskCount">0</h3>
                                        <p>High Risk</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-box">
                                        <h3 class="text-warning" id="mediumRiskCount">0</h3>
                                        <p>Medium Risk</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-box">
                                        <h3 class="text-success" id="lowRiskCount">0</h3>
                                        <p>Low Risk</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Table -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-table"></i> Prediction Results</h5>
                            <button class="btn btn-sm btn-light" onclick="exportResults()">
                                <i class="fas fa-file-excel"></i> Export to CSV
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                <table class="table table-sm table-hover table-striped" id="resultsTable">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th>Vendor ID</th>
                                            <th>Category</th>
                                            <th>Invoice Amount</th>
                                            <th>Prediction</th>
                                            <th>Probability</th>
                                            <th>Risk Level</th>
                                        </tr>
                                    </thead>
                                    <tbody id="resultsTableBody">
                                        <!-- Results will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.stat-box {
    padding: 20px;
    border-right: 1px solid #ddd;
}
.stat-box:last-child {
    border-right: none;
}
.stat-box h3 {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 5px;
}
</style>

<script>
let resultsData = [];

document.getElementById('bulkUploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('csvFile');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a file');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    document.getElementById('uploadBtn').disabled = true;
    document.getElementById('progressDiv').style.display = 'block';
    
    try {
        const response = await fetch('/api/bulk-predict', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            resultsData = result.results;
            displayResults(result);
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    } finally {
        document.getElementById('uploadBtn').disabled = false;
        document.getElementById('progressDiv').style.display = 'none';
    }
});

function displayResults(result) {
    // Update summary stats
    document.getElementById('totalCount').textContent = result.summary.total;
    document.getElementById('highRiskCount').textContent = result.summary.high_risk;
    document.getElementById('mediumRiskCount').textContent = result.summary.medium_risk;
    document.getElementById('lowRiskCount').textContent = result.summary.low_risk;
    
    // Populate table
    const tbody = document.getElementById('resultsTableBody');
    tbody.innerHTML = '';
    
    result.results.forEach(row => {
        const tr = document.createElement('tr');
        const predColor = row.prediction === 'DELAYED' ? 'danger' : 'success';
        const riskColor = row.risk_level === 'HIGH' ? 'danger' : row.risk_level === 'MEDIUM' ? 'warning' : 'success';
        
        tr.innerHTML = `
            <td><strong>${row.vendor_id}</strong></td>
            <td>${row.vendor_category}</td>
            <td>$${parseFloat(row.invoice_amount).toLocaleString()}</td>
            <td><span class="badge bg-${predColor}">${row.prediction}</span></td>
            <td>${(row.probability * 100).toFixed(1)}%</td>
            <td><span class="badge bg-${riskColor}">${row.risk_level}</span></td>
        `;
        
        tbody.appendChild(tr);
    });
    
    // Show results section
    document.getElementById('resultsSection').style.display = 'block';
    
    // Scroll to results
    document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
}

function downloadSampleCSV() {
    const csv = `vendor_id,vendor_category,invoice_amount,payment_terms,vendor_past_delays,cash_flow_level,vendor_relationship_length,invoice_date,due_date,days_until_due,vendor_reliability_score,vendor_risk_score
V_001,Technology,25000,30,2,Medium,12,2025-01-15,2025-02-14,30,90,10
V_002,Services,50000,45,5,Low,24,2025-01-15,2025-03-01,45,75,25
V_003,Manufacturing,15000,30,0,High,36,2025-01-15,2025-02-14,30,100,0`;
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'sample_invoices.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

function exportResults() {
    if (resultsData.length === 0) {
        alert('No results to export');
        return;
    }
    
    // Convert to CSV
    const headers = Object.keys(resultsData[0]);
    const csvContent = [
        headers.join(','),
        ...resultsData.map(row => headers.map(h => row[h]).join(','))
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `predictions_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}
</script>
{% endblock %}
