{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="content-wrapper">
        <h2 class="mb-4"><i class="fas fa-tachometer-alt"></i> Analytics Dashboard</h2>
        
        <!-- Overview Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center bg-primary text-white">
                    <div class="card-body">
                        <h3>{{ stats.total_records }}</h3>
                        <p class="mb-0">Total Payments</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-success text-white">
                    <div class="card-body">
                        <h3>{{ stats.on_time_count }}</h3>
                        <p class="mb-0">On-Time Payments</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-danger text-white">
                    <div class="card-body">
                        <h3>{{ stats.delayed_count }}</h3>
                        <p class="mb-0">Delayed Payments</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-warning text-white">
                    <div class="card-body">
                        <h3>{{ stats.delay_rate }}%</h3>
                        <p class="mb-0">Delay Rate</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Model Performance -->
        <div class="row mb-4">
            <div class="col-12">
                <h4 class="mb-3">Model Performance Comparison</h4>
                <canvas id="modelPerformanceChart" height="80"></canvas>
            </div>
        </div>

        <!-- Top Features -->
        <div class="row mb-4">
            <div class="col-md-6">
                <h4 class="mb-3">Top 5 Predictive Features</h4>
                <div class="list-group">
                    {% for feature in stats.top_features %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-chart-line text-primary"></i> {{ feature.name }}</span>
                        <span class="badge bg-primary rounded-pill">{{ (feature.importance * 100) | round(2) }}%</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Category Breakdown -->
            <div class="col-md-6">
                <h4 class="mb-3">Delay Rate by Vendor Category</h4>
                <canvas id="categoryChart" height="200"></canvas>
            </div>
        </div>

        <!-- Data Table -->
        <div class="row">
            <div class="col-12">
                <h4 class="mb-3">Vendor Category Statistics <small class="text-muted">(Click category to see vendors)</small></h4>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Category</th>
                                <th>Total Payments</th>
                                <th>Delayed</th>
                                <th>Delay Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cat in stats.category_stats %}
                            <tr style="cursor: pointer;" onclick="showVendors('{{ cat.category }}')" data-bs-toggle="tooltip" title="Click to view vendors in {{ cat.category }}">
                                <td><strong><i class="fas fa-folder-open text-primary me-2"></i>{{ cat.category }}</strong></td>
                                <td>{{ cat.total }}</td>
                                <td>{{ cat.delayed }}</td>
                                <td>
                                    <span class="badge {% if cat.delay_rate > 30 %}bg-danger{% elif cat.delay_rate > 20 %}bg-warning{% else %}bg-success{% endif %}">
                                        {{ cat.delay_rate }}%
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vendor Details Modal -->
<div class="modal fade" id="vendorModal" tabindex="-1" aria-labelledby="vendorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="vendorModalLabel">
                    <i class="fas fa-building me-2"></i>Vendors in <span id="categoryName"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Vendor ID</th>
                                <th>Total Payments</th>
                                <th>Delayed Payments</th>
                                <th>Delay Rate</th>
                            </tr>
                        </thead>
                        <tbody id="vendorTableBody">
                            <!-- Vendor data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden data for JavaScript -->
<script id="vendorData" type="application/json">
    {{ stats.vendor_by_category | tojson }}
</script>

<script>
// Store vendor data
const vendorsByCategory = JSON.parse(document.getElementById('vendorData').textContent);

// Function to show vendors for a category
function showVendors(category) {
    const vendors = vendorsByCategory[category];
    const tbody = document.getElementById('vendorTableBody');
    const categoryNameSpan = document.getElementById('categoryName');
    
    // Update modal title
    categoryNameSpan.textContent = category;
    
    // Clear existing rows
    tbody.innerHTML = '';
    
    // Add vendor rows
    if (vendors && vendors.length > 0) {
        vendors.forEach(vendor => {
            const row = document.createElement('tr');
            const delayRateClass = vendor.delay_rate > 30 ? 'bg-danger' : vendor.delay_rate > 20 ? 'bg-warning' : 'bg-success';
            
            row.innerHTML = `
                <td><strong>${vendor.vendor_id}</strong></td>
                <td>${vendor.total}</td>
                <td>${vendor.delayed}</td>
                <td>
                    <span class="badge ${delayRateClass}">
                        ${vendor.delay_rate.toFixed(2)}%
                    </span>
                </td>
            `;
            tbody.appendChild(row);
        });
    } else {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No vendors found</td></tr>';
    }
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('vendorModal'));
    modal.show();
}

// Initialize tooltips
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl)
});

// Model Performance Chart
const modelCtx = document.getElementById('modelPerformanceChart').getContext('2d');
new Chart(modelCtx, {
    type: 'bar',
    data: {
        labels: ['Logistic Regression', 'Random Forest', 'XGBoost', 'LightGBM'],
        datasets: [{
            label: 'Accuracy (%)',
            data: [{{ results.logistic_regression.accuracy * 100 | default(0) }}, {{ results.random_forest.accuracy * 100 | default(0) }}, 
                   {{ results.xgboost.accuracy * 100 | default(0) }}, {{ results.lightgbm.accuracy * 100 | default(0) }}],
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 2
        }, {
            label: 'AUC-ROC (%)',
            data: [{{ results.logistic_regression.auc * 100 | default(0) }}, {{ results.random_forest.auc * 100 | default(0) }}, 
                   {{ results.xgboost.auc * 100 | default(0) }}, {{ results.lightgbm.auc * 100 | default(0) }}],
            backgroundColor: 'rgba(255, 99, 132, 0.6)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: 'top' },
            title: { display: true, text: 'Model Performance Metrics' }
        },
        scales: {
            y: { beginAtZero: true, max: 100 }
        }
    }
});

// Category Breakdown Chart
const catCtx = document.getElementById('categoryChart').getContext('2d');
new Chart(catCtx, {
    type: 'doughnut',
    data: {
        labels: [{% for cat in stats.category_stats %}'{{ cat.category }}'{% if not loop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            data: [{% for cat in stats.category_stats %}{{ cat.delay_rate }}{% if not loop.last %}, {% endif %}{% endfor %}],
            backgroundColor: [
                'rgba(255, 99, 132, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 206, 86, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(153, 102, 255, 0.6)',
                'rgba(255, 159, 64, 0.6)',
                'rgba(199, 199, 199, 0.6)'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: 'right' },
            title: { display: false }
        }
    }
});
</script>
{% endblock %}
